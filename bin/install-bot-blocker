#!/usr/bin/env php
<?php

if (is_dir( __DIR__ . "/../vendor")) {
	require_once __DIR__ . "/../vendor/autoload.php";
} else {
	require_once __DIR__ . "/../autoload.php";
}

$error = false;

$serviceFilePath = "/etc/systemd/system/bot-blocker.service";
if (is_file($serviceFilePath)) {
	fwrite(STDERR, "Service 'bot-blocker.service' is already installed\n");
	$error = true;
} else {
	$pathToBotBlocker = __DIR__ . "/bot-blocker";
	$phpBin = PHP_BINARY;
	$serviceFileContent = <<<EOF
[Service]
Type=simple
ExecStart={$phpBin} -d disable_functions {$pathToBotBlocker}
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF;


	file_put_contents($serviceFilePath, $serviceFileContent);
	shell_exec("systemctl enable bot-blocker");
	echo ("To start the start run:\n\tsystemctl start bot-blocker\n");
}

$logRotationConfPath = "/etc/logrotate.d/bot-blocker";
if (is_file($logRotationConfPath)) {
	fwrite(STDERR, "Log rotation for bot-blocker is already configured\n");
	$error = true;
} else {
	$logRotationConfContent = <<<EOF
/var/log/bot-blocker.log {
    daily
    rotate 7
    compress
}
EOF;
	file_put_contents($logRotationConfPath, $logRotationConfContent);
}
if ($error) {
	exit(1);
}